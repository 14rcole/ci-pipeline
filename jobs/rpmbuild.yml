- job:
    name: ci-pipeline-rpmbuild
    defaults: ci-pipeline-defaults
    parameters:
        - string:
            name: fed_username
            description: |
              fedmsg username
        - string:
            name: fed_stats
            description: |
              fedmsg stats
        - string:
            name: fed_name
            description: |
              fedmsg name
        - string:
            name: fed_namespace
            description: |
              fedmsg namespace
        - string:
            name: fed_rev
            description: |
              fedmsg rev
        - string:
            name: fed_agent
            description: |
              fedmsg agent
        - string:
            name: fed_summary
            description: |
              fedmsg summary
        - string:
            name: fed_repo
            description: |
              fedmsg repo
        - string:
            name: fed_branch
            description: |
              fedmsg branch
        - string:
            name: fed_path
            description: |
              fedmsg path
        - string:
            name: fed_seen
            description: |
              fedmsg seen
        - string:
            name: fed_message
            description: |
              fedmsg message
        - string:
            name: fed_email
            description: |
              fedmsg email
    builders:
#        - system-groovy:
#            command: build.description = build.getEnvironment().get('fed_repo')
        - shell: |
            # Write ci message fields to a file
            echo "topic=org.centos.prod.ci.pipeline.package.running" >> ${WORKSPACE}/job.properties_running
            echo "build_url=$BUILD_URL" >> ${WORKSPACE}/job.properties_running
            echo "build_id=$BUILD_ID" >> ${WORKSPACE}/job.properties_running
            echo "ref=fedora/${fed_branch}/x86_64/atomic-host" >> ${WORKSPACE}/job.properties_running
            echo "rev=$fed_rev" >> ${WORKSPACE}/job.properties_running
            echo "namespace=rpms" >> ${WORKSPACE}/job.properties_running
            echo "repo=$fed_repo" >> ${WORKSPACE}/job.properties_running
            echo "status=success" >> ${WORKSPACE}/job.properties_running
            echo "test_guidance=''" >> ${WORKSPACE}/job.properties_running
        - inject:
            properties-file: ${WORKSPACE}/job.properties_running
        - jms-messaging:
            #override-topic: ${topic}
            override-topic: org.centos.prod.ci.pipeline.package
            provider-name: fedmsg
            msg-type: Custom
            msg-props: |
              topic=${topic}
              username=fedora-atomic
            msg-content: |
              {
                "build_url": "${BUILD_URL}",
                "build_id": "${BUILD_ID}",
                "ref": "${ref}",
                "rev": "${rev}",
                "namespace": "${namespace}",
                "repo": "${repo}",
                "status": "${status}",
                "test_guidance": "${test_guidance}"
              }
        - ci-pipeline-duffy-builder:
            task: rpmbuild-test
            variables: |
                export JENKINS_JOB_NAME="${JOB_NAME}"
                export JENKINS_BUILD_TAG="${BUILD_TAG}"
                export OSTREE_BRANCH="${OSTREE_BRANCH:-}"
                export fed_repo="${fed_repo}"
                export fed_branch="${fed_branch}"
                export fed_rev="${fed_rev}"
            playbook: ci-pipeline/config/duffy-setup/setup-rpmbuild-system.yml
        - inject:
            properties-file: ${WORKSPACE}/logs/description.txt
#        - system-groovy:
#            command: build.description = build.getEnvironment().get('description')
        - shell: |
            echo "topic=org.centos.prod.ci.pipeline.package.complete" >> ${WORKSPACE}/job.properties
            package=$(cat ${WORKSPACE}/logs/packagename.txt)
            status=$(curl $JENKINS_URL/job/$JOB_NAME/lastBuild/api/json 2>/dev/null | jq '.result')
            echo "status=$status" >> ${WORKSPACE}/job.properties
            echo "package_url=http://artifacts.ci.centos.org/fedora-atomic/rawhide/repo/${fed_repo}_repo/$package" >> ${WORKSPACE}/job.properties
        - inject:
            properties-file: ${WORKSPACE}/job.properties
        - jms-messaging:
            #override-topic: ${topic}
            override-topic: org.centos.prod.ci.pipeline.package
            provider-name: fedmsg
            msg-type: Custom
            msg-props: |
              topic=${topic}
              username=fedora-atomic
            msg-content: |
              {
                "build_url": "${BUILD_URL}",
                "build_id": "${BUILD_ID}",
                "ref": "${ref}",
                "rev": "${rev}",
                "namespace": "${namespace}",
                "repo": "${repo}",
                "status": "${status}",
                "test_guidance": "${test_guidance}"
              }
    publishers:
        - archive:
            artifacts: '*.*, */*, */*/*'
            allow-empty: 'true'
        - trigger-parameterized-builds:
            - project: 'ci-pipeline-ostree-compose'
              predefined-parameters: fed_branch=$fed_branch
              condition: SUCCESS
        - ci-pipeline-duffy-publisher
