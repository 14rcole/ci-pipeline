- builder:
    name: ci-pipeline-duffy-builder
    builders:
        - macro-cciskel-duffy-prepared-allocate:
            jobclass: builder
            duffytimeoutsecs: 3600
            playbook: aos-ci/config/duffy-setup/setup-rpmbuild-system.yml
        - shell: |
            #!/bin/bash
            set -xeuo pipefail
            (echo -n "export RSYNC_PASSWORD=" && cat ~/duffy.key | cut -c '-13') > rsync-password.sh
            cat >>task.env <<EOF
            export JENKINS_JOB_NAME="${{JOB_NAME}}"
            export JENKINS_BUILD_TAG="${{BUILD_TAG}}"
            export fed_repo="${{fed_repo}}"
            export fed_branch="${{fed_branch}}"
            export fed_rev="${{fed_rev}}"
            EOF
            cat task.env
            rsync -Hrlptv --stats -e ssh task.env rsync-password.sh builder@${{DUFFY_HOST}}:${{JOB_NAME}}
            rsync -Hrlptv --stats --delete -e ssh aos-ci/ builder@${{DUFFY_HOST}}:${{JOB_NAME}}/aos-ci

            build_success=true
            if ! ssh -tt builder@${{DUFFY_HOST}} "pushd ${{JOB_NAME}} && . rsync-password.sh && . task.env && ./aos-ci/tasks/{task}"; then
                build_success=false
            fi

            rsync -Hrlptv --stats -e ssh builder@${{DUFFY_HOST}}:${{JOB_NAME}}/logs/ $WORKSPACE/logs || true
            # Exit with code from the build
            if test "${{build_success}}" = "false"; then
                echo 'Build failed, see logs above'; exit 1
            fi

- publisher:
    name: ci-pipeline-duffy-publisher
    publishers:
        - archive:
            artifacts: 'logs/**'
            allow-empty: 'true'
        - trigger:
            project: 'ci-pipeline-ostree-compose'
            threshold: SUCCESS
        - macro-cciskel-duffy-deallocate

- job-template:
    name: ci-pipeline-rpmbuild
    defaults: ci-pipeline-defaults
    concurrent: false
    logrotate:
      numToKeep: 30
      artifactNumToKeep: 15
    parameters:
        - string:
            name: fed_username
            description: |
              fedmsg username
        - string:
            name: fed_stats
            description: |
              fedmsg stats
        - string:
            name: fed_name
            description: |
              fedmsg name
        - string:
            name: fed_namespace
            description: |
              fedmsg namespace
        - string:
            name: fed_rev
            description: |
              fedmsg rev
        - string:
            name: fed_agent
            description: |
              fedmsg agent
        - string:
            name: fed_summary
            description: |
              fedmsg summary
        - string:
            name: fed_repo
            description: |
              fedmsg repo
        - string:
            name: fed_branch
            description: |
              fedmsg branch
        - string:
            name: fed_path
            description: |
              fedmsg path
        - string:
            name: fed_seen
            description: |
              fedmsg seen
        - string:
            name: fed_message
            description: |
              fedmsg message
        - string:
            name: fed_email
            description: |
              fedmsg email
    builders:
        - system-groovy:
           command: build.description = build.getEnvironment().get('fed_repo')
        - ci-pipeline-duffy-builder:
            task: rpmbuild-test
        - inject:
            properties-file: ${{WORKSPACE}}/logs/description.txt
        - system-groovy:
           command: build.description = build.getEnvironment().get('description')

    publishers:
      - archive:
          artifacts: '*.*, */*, */*/*'
          allow-empty: 'true'
      - ci-pipeline-duffy-publisher

## Describes the project
- project:
    name: ci-pipeline-rpmbuild-jobs
    jobs:
      - ci-pipeline-rpmbuild
