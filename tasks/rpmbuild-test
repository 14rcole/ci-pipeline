#!/bin/bash
set +e

# Need to test to make sure fedpkg rpm is installed
lsblk
echo ""
df -h
pwd
sudo yum -y install fedpkg gcc rpm-build
which fedpkg
if [ "$?" != 0 ]; then echo "ERROR: FEDPKG RPM NOT INSTALLED\nSTATUS: $?"; exit 1; fi
# Clone the fedoraproject git repo
rm -rf $fed_repo
fedpkg clone -a $fed_repo
if [ "$?" != 0 ]; then echo "ERROR: FEDPKG CLONE\nSTATUS: $?"; exit 1; fi
pushd $fed_repo
# Checkout the proper branch
git checkout $fed_branch
# Checkout the commit from the fedmsg
git checkout $fed_rev
# Create new branch because fedpkg wont build with detached head
git checkout -b test_branch
# fedpkg prep to unpack the tarball
fedpkg --release $fed_branch prep
# Make sure we have rpmspec before we call it
which rpmspec
if [ "$?" != 0 ]; then echo "ERROR: RPMSPEC RPM NOT INSTALLED\nSTATUS: $?"; exit 1; fi
VERSION=$(rpmspec --queryformat "%{VERSION}\n" -q ${fed_repo}.spec | head -n 1)
# Some packages are packagename-version-release, some packagename-sha
pushd ${fed_repo}-*
# Run configure if it exists, if not, no big deal
./configure
# Run tests if they are there
make test
MAKE_TEST_STATUS=$?
popd
if [ "$MAKE_TEST_STATUS" == 2 ]; then
#     sudo echo "description='$fed_repo - No tests'" >> ${WORKSPACE}/fedmsg_fields.txt
     sudo echo "description='$fed_repo - No tests'"
else
#     sudo echo "description=$fed_repo" >> ${WORKSPACE}/fedmsg_fields.txt
     sudo echo "description=$fed_repo"
fi
# Build the package into ./results_$fed_repo/$VERSION/$RELEASE/
export TMPDIR=/home/builder/${fed_repo}
fedpkg --release $fed_branch mockbuild
lsblk
echo ""
df -h
if [ "$?" != 0 ]; then echo "ERROR: FEDPKG MOCKBUILD\nSTATUS: $?"; exit 1; fi
popd

# Run fedabipkgdiff against the newly created rpm
ABIGAIL_BRANCH=$(echo $fed_branch | sed 's/./&c/1')
if [ "${fed_branch}" = "master" ]; then
    ABIGAIL_BRANCH="fc27"
fi
git clone git://sourceware.org/git/libabigail.git
#libabigail/tools/fedabipkgdiff --from ${ABIGAIL_BRANCH} ${fed_repo}/results_${fed_repo}/${VERSION}/*/*.rpm > ${WORKSPACE}/fedabipkgdiff_out.txt
libabigail/tools/fedabipkgdiff --from ${ABIGAIL_BRANCH} ${fed_repo}/results_${fed_repo}/${VERSION}/*/*.rpm

# TODO: get rest of the rpms and build ostree

exit 0
