#!/bin/sh
set -xeuo pipefail

# Find the base dir
base_dir="$(dirname $0)/.."

if [ "${BUILD}" = "master" -o "${BUILD}" = "rawhide" ]; then
    BUILD="rawhide"
    VERSION="rawhide"
else
    VERSION=$(echo $BUILD | sed -e 's/[a-zA-Z]*//')
fi

REF="fedora/${BUILD}/x86_64/atomic-host"

mkdir -p logs

for v in netinst ostree images; do
    rsync --delete --stats -a fedora-atomic@artifacts.ci.centos.org::fedora-atomic/${BUILD}/${v}/ ${v}/
done

currentdir=$(pwd)

# Clean up the imagefactory storage directory
imgdir=/var/lib/imagefactory/storage/
sudo rm -f $imgdir/*

# Create directory for temporary files
tmpdir=$(mktemp -d)

# Kill backgrounded jobs on exit
function clean_up {
    kill $(jobs -p)
    for screenshot in /var/lib/oz/screenshots/*.ppm; do
        [ -e "$screenshot" ] && cp $screenshot $currentdir/logs
    done
    [ -e "$tmpdir/fedora-atomic.ks" ] && cp $tmpdir/fedora-atomic.ks $currentdir/logs
    sudo rm -f $imgdir/*
    sudo rm -rf $tmpdir
}
trap clean_up EXIT SIGHUP SIGINT SIGTERM

version=$(ostree --repo=ostree show --print-metadata-key=version $REF| sed -e "s/'//g")
release=$(ostree --repo=ostree rev-parse $REF| cut -c -15)
if [ -d "images" ]; then
    # Find the last image we pushed
    prev_img=$(ls -tr images/*.qcow2 | tail -n 1)
    prev_rel=$(echo $prev_img | sed -e 's/.*-\([^-]*\).qcow2/\1/')
    rpm-ostree db --repo=ostree diff $prev_rel $release | tee logs/packages.txt
else
    mkdir images
fi

# Enable port 8000
zone=$(firewall-cmd --get-default-zone)
sudo firewall-cmd --zone=$zone --add-port=8000/tcp

# First argument is the path to the ostree repo share that over httpd now
pushd ostree
python -m SimpleHTTPServer &
popd

# Change into tmpdir
pushd $tmpdir

# Grab the kickstart file
#curl -O -L https://pagure.io/fedora-kickstarts/raw/master/f/fedora-atomic.ks
cp $currentdir/ci-pipeline/config/ostree/fedora-atomic-${BUILD}.ks fedora-atomic.ks

# Put new url into the kickstart file
sed -i "s|^ostreesetup.*|ostreesetup --nogpg --osname=fedora-atomic --remote=fedora-atomic --url=http://192.168.122.1:8000/ --ref=$REF|" ./fedora-atomic.ks

# point to upstream
sed -i "s|\(%end.*$\)|ostree remote delete fedora-atomic\nostree remote add --set=gpg-verify=false fedora-atomic http://artifacts.ci.centos.org/artifacts/fedora-atomic/${BUILD}/ostree\n\1|" ./fedora-atomic.ks

# Create a tdl file for imagefactory
#       <install type='url'>
#           <url>http://download.fedoraproject.org/pub/fedora/linux/releases/25/Everything/x86_64/os/</url>
#       </install>
cat <<EOF >./fedora-${BUILD}.tdl
<template>
    <name>${BUILD}</name>
    <os>
        <name>Fedora</name>
        <version>${VERSION}</version>
        <arch>x86_64</arch>
        <install type='iso'>
            <iso>file://${currentdir}/netinst/Fedora-Everything-netinst-x86_64.iso</iso>
        </install>
        <rootpw>password</rootpw>
        <kernelparam>console=ttyS0</kernelparam>
    </os>
</template>
EOF
#       <install type='url'>
#           <url>http://dl.fedoraproject.org/pub/fedora/linux/releases/25/Everything/x86_64/os/</url>

# â€“parameter results_location
# run imagefactory to build disk image
sudo imagefactory --debug --imgdir $imgdir --timeout 3000 base_image ./fedora-${BUILD}.tdl --parameter offline_icicle true --file-parameter install_script ./fedora-atomic.ks

# Change out of temporary directory
popd

# convert to qcow
imgname="fedora-atomic-$version-$release"
qemu-img convert -c -p -O qcow2 $imgdir/*body ./images/$imgname.qcow2

# delete images over 3 days old
find ./images -mtime +3 -exec rm {} \;

# Also delete if we have more than 3 images (from manual runs)
pushd images
ls -t | sed -e '1,3d' | xargs --no-run-if-empty -d '\n' rm
ln -sf $imgname.qcow2 latest-atomic.qcow2
popd

# Record the commit so we can test it later
commit=$(ostree --repo=ostree rev-parse ${REF})
cat << EOF > logs/ostree.props
builtcommit=$commit
image2boot="http://artifacts.ci.centos.org/artifacts/fedora-atomic/${BUILD}/images/$imgname.qcow2"
image_name="$imgname.qcow2"
EOF

# We don't need to rsync ostree back since we just used it for cache
for v in images; do
    rsync --delete --stats -a ${v}/ fedora-atomic@artifacts.ci.centos.org::fedora-atomic/${BUILD}/${v}/
done
