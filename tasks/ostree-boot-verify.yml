---
- hosts: '{{ hosts | default("all") }}'
  become: '{{ become | default("no") }}'
  become_user: '{{ become_user | default("root") }}'
  remote_user: '{{ remote_user | default("root") }}'
  tasks:
      - name: Get rpm-ostree status --json output
        command: rpm-ostree status --json
        register: ros

      - name: Convert to JSON
        set_fact:
            ros_json: "{{ ros.stdout|from_json }}"

      - name: Set ros variable if deployment 0 is booted
        set_fact:
            ros_booted: "{{ ros_json['deployments'][0] }}"
            ros_not_booted: "{{ ros_json['deployments'][1] if ros_json['deployments'][1] is defined else false }}"
            when: ros_json['deployments'][0] is defined and ros_json['deployments'][0]['booted']

      - name: Set ros variable if deployment 1 is booted
        set_fact:
            ros_booted: "{{ ros_json['deployments'][1] }}"
            ros_not_booted: "{{ ros_json['deployments'][0] if ros_json['deployments'][0] is defined else false }}"
            when: ros_json['deployments'][1] is defined and ros_json['deployments'][1]['booted']

      - name: Deploy specific commit
        command: "atomic host deploy {{ commit }}"
        when: ros_booted['checksum'] != commit
        notify: restart system

      - name: Get rpm-ostree status --json output
        command: rpm-ostree status --json
        register: ros

      - name: Convert to JSON
        set_fact:
            ros_json: "{{ ros.stdout|from_json }}"

      - name: Set ros variable if deployment 0 is booted
        set_fact:
            ros_booted: "{{ ros_json['deployments'][0] }}"
            ros_not_booted: "{{ ros_json['deployments'][1] if ros_json['deployments'][1] is defined else false }}"
            when: ros_json['deployments'][0] is defined and ros_json['deployments'][0]['booted']

      - name: Set ros variable if deployment 1 is booted
        set_fact:
            ros_booted: "{{ ros_json['deployments'][1] }}"
            ros_not_booted: "{{ ros_json['deployments'][0] if ros_json['deployments'][0] is defined else false }}"
            when: ros_json['deployments'][1] is defined and ros_json['deployments'][1]['booted']

      - name: Verify specific commit
        fail:
            msg: "commit: {{ commit }} not installed"
        when: ros_booted['checksum'] != commit
  handlers:
      - name: restart system
        command: shutdown -r +1 "Ansible reboot triggered"
        async: 1
        poll: 0
        ignore_errors: true
        notify: ssh stopped
      - name: ssh stopped
        local_action:
            wait_for host={{ ansible_ssh_host | default(inventory_hostname) }}
            port=22 state=stopped
        notify: ssh started
      - name: ssh started
        local_action:
            wait_for host={{ ansible_ssh_host | default(inventory_hostname) }}
            port=22 state=started
        notify: pause 5 seconds
      - name: pause 5 seconds
        pause: seconds=5
