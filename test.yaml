- job-template:
    name: 'TODO'
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
#    concurrent: TODO
#    node: TODO
#    logrotate:
#      numToKeep: 30
#      artifactNumToKeep: 15
    wrappers:
      - ansicolor
      - workspace-cleanup
      - timestamps
# TODO: trigger
    parameters:
        - string:
            name: FEDMSG
            description: |
              fedmsg
    builders:
        - shell: |
            #!/bin/bash
            set -xuo pipefail

            # Write script to parse fields (can likely be improved)
            cat << EOF > ${{WORKSPACE}}/parse_fedmsg.py
            #!/bin/env python
            import json
            import sys

            message = json.load(sys.stdin)
            if 'msg' in message:
                if 'commit' in message['msg']
                     msg = message['msg']['commit']
            
                for key in msg:
                    print "fed_%s=%s" % (key, msg[key])
            EOF
            chmod +x ${{WORKSPACE}}/parse_fedmsg.py

            # Write fedmsg fields to a file to inject them
            if [ -n "$FEDMSG" ]; then
                echo $FEDMSG | ${{WORKSPACE}}/parse_fedmsg.py > fedmsg_fields.txt
            fi

        - inject:
            properties-file: ${{WORKSPACE}}/fedmsg_fields.txt
        - system-groovy:
           command: build.description = build.getEnvironment().get('fed_repo')
        - shell: |

            # Need to test to make sure fedpkg rpm is installed
            # TODO
            # Clone the fedoraproject git repo
            fedpkg clone -a $fed_repo
            if [ "$?" != 0 ]; then echo "ERROR: FEDPKG CLONE\nSTATUS: $?"; exit 1; fi
            pushd $fed_repo
            # Checkout the proper branch
            git checkout $fed_branch
            # Checkout the commit from the fedmsg
            git checkout $fed_rev
            # Create new branch because fedpkg wont build with detached head
            git branch -b test_branch
            # Build the package into ./$ARCH/
            fedpkg --release $fed_branch mockbuild
            if [ "$?" != 0 ]; then echo "ERROR: FEDPKG MOCKBUILD\nSTATUS: $?"; exit 1; fi
            popd

            # TODO: get rest of the rpms and build ostree
            
            exit 0

    publishers:
      - archive:
          artifacts: '*.*'
          allow-empty: 'true'

## Describes the project
- project:
    name: TODO
    jobs:
      - TODO
